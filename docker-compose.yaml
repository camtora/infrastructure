version: "2.4"

services:
  # ============== NGINX ==============
  # Main reverse proxy handling all *.camerontora.ca traffic
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      - oauth2-proxy

  # ============== OAUTH2 PROXY ==============
  # Single auth provider for all protected services
  # Shared cookie across all *.camerontora.ca subdomains
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    container_name: oauth2-proxy
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Google OAuth provider
      OAUTH2_PROXY_PROVIDER: "google"
      OAUTH2_PROXY_CLIENT_ID: ${OAUTH2_PROXY_CLIENT_ID}
      OAUTH2_PROXY_CLIENT_SECRET: ${OAUTH2_PROXY_CLIENT_SECRET}

      # Cookie settings - CRITICAL for SSO
      OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_PROXY_COOKIE_SECRET}
      OAUTH2_PROXY_COOKIE_NAME: "_oauth2_proxy"
      OAUTH2_PROXY_COOKIE_DOMAIN: ".camerontora.ca"
      OAUTH2_PROXY_COOKIE_SECURE: "true"
      OAUTH2_PROXY_COOKIE_SAMESITE: "lax"
      OAUTH2_PROXY_COOKIE_REFRESH: "168h"
      OAUTH2_PROXY_COOKIE_EXPIRE: "720h"

      # Email restrictions
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_AUTHENTICATED_EMAILS_FILE: "/etc/oauth2-proxy/authenticated_emails.txt"

      # Proxy settings
      OAUTH2_PROXY_REVERSE_PROXY: "true"
      OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:4180"

      # Whitelist redirect domains for all subdomains
      OAUTH2_PROXY_WHITELIST_DOMAINS: ".camerontora.ca"

    volumes:
      - ./oauth2-proxy:/etc/oauth2-proxy:ro
    command:
      # No upstream - nginx handles routing, oauth2-proxy just does auth
      - --upstream=static://202
      - --set-xauthrequest=true
      - --pass-user-headers=true
      - --skip-provider-button=true
      - --silence-ping-logging=true
      - --cookie-csrf-per-request=true
      - --cookie-csrf-expire=5m
      # Explicit cookie domain for SSO across subdomains
      - --cookie-domain=.camerontora.ca

volumes:
  nginx-logs:
