version: "2.4"

services:
  # ============== NGINX ==============
  # Main reverse proxy handling all *.camerontora.ca traffic
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/html:/usr/share/nginx/html:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/acme:/var/www/acme:ro  # ACME challenge for certbot webroot
      - nginx-logs:/var/log/nginx
    depends_on:
      - oauth2-proxy

  # ============== OAUTH2 PROXY ==============
  # Single auth provider for all protected services
  # Shared cookie across all *.camerontora.ca subdomains
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    container_name: oauth2-proxy
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Google OAuth provider
      OAUTH2_PROXY_PROVIDER: "google"
      OAUTH2_PROXY_CLIENT_ID: ${OAUTH2_PROXY_CLIENT_ID}
      OAUTH2_PROXY_CLIENT_SECRET: ${OAUTH2_PROXY_CLIENT_SECRET}

      # Cookie settings - CRITICAL for SSO
      OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_PROXY_COOKIE_SECRET}
      OAUTH2_PROXY_COOKIE_NAME: "_oauth2_proxy"
      OAUTH2_PROXY_COOKIE_DOMAIN: ".camerontora.ca"
      OAUTH2_PROXY_COOKIE_SECURE: "true"
      OAUTH2_PROXY_COOKIE_SAMESITE: "lax"
      OAUTH2_PROXY_COOKIE_REFRESH: "168h"
      OAUTH2_PROXY_COOKIE_EXPIRE: "720h"

      # Email restrictions
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_AUTHENTICATED_EMAILS_FILE: "/etc/oauth2-proxy/authenticated_emails.txt"

      # Proxy settings
      OAUTH2_PROXY_REVERSE_PROXY: "true"
      OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:4180"

      # Whitelist redirect domains for all subdomains
      OAUTH2_PROXY_WHITELIST_DOMAINS: ".camerontora.ca"

    volumes:
      - ./oauth2-proxy:/etc/oauth2-proxy:ro
    command:
      # No upstream - nginx handles routing, oauth2-proxy just does auth
      - --upstream=static://202
      - --set-xauthrequest=true
      - --pass-user-headers=true
      - --pass-access-token=true
      - --skip-provider-button=true
      - --silence-ping-logging=true
      - --cookie-csrf-per-request=true
      - --cookie-csrf-expire=5m
      # Explicit cookie domain for SSO across subdomains
      - --cookie-domain=.camerontora.ca

  # ============== NETDATA ==============
  # Real-time system monitoring (CPU, RAM, disk, network)
  netdata:
    image: netdata/netdata
    container_name: netdata
    restart: unless-stopped
    pid: host
    network_mode: host
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    volumes:
      - netdata-config:/etc/netdata
      - netdata-lib:/var/lib/netdata
      - netdata-cache:/var/cache/netdata
      - ./netdata/health_alarm_notify.conf:/etc/netdata/health_alarm_notify.conf:ro
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /etc/localtime:/etc/localtime:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
      - /var/log:/host/var/log:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - NETDATA_CLAIM_TOKEN=${NETDATA_CLAIM_TOKEN:-}
      - NETDATA_CLAIM_URL=https://app.netdata.cloud

  # ============== HEALTH API ==============
  # External monitoring endpoint for GCP Cloud Run
  # Exposes system metrics, Plex status, and speed test results
  # Also provides admin endpoints for VPN management (OAuth protected)
  health-api:
    build: ./health-api
    container_name: health-api
    restart: unless-stopped
    pid: host
    ports:
      - "5000:5000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      # Speed test results written by cron job
      - /var/lib/health-api:/data:ro
      # Mount host paths for disk usage checks
      - /:/hostfs/root:ro
      - /home:/hostfs/home:ro
      - /var:/hostfs/var:ro
      - /tmp:/hostfs/tmp:ro
      - /dev/shm:/hostfs/shm:ro
      - /CAMRAID:/hostfs/CAMRAID:ro
      - /HOMENAS:/hostfs/HOMENAS:ro
      # Mount /proc for CPU/memory stats
      - /proc:/host/proc:ro
      # Docker socket for container management (admin features)
      - /var/run/docker.sock:/var/run/docker.sock
      # Config files for VPN switching (admin features)
      - /home/camerontora/docker-services:/docker-services
      - /home/camerontora/infrastructure/nginx/conf.d:/nginx-conf
    environment:
      - HEALTH_API_KEY=${HEALTH_API_KEY:-}
      - PLEX_URL=http://host.docker.internal:32400
      - PLEX_TOKEN=${PLEX_TOKEN:-}
      - SPEEDTEST_FILE=/data/speedtest.json
      # Tell psutil to use host's /proc
      - HOST_PROC=/host/proc
      # Admin configuration
      - ADMIN_EMAILS=${ADMIN_EMAILS:-cameron.tora@gmail.com}

volumes:
  nginx-logs:
  netdata-config:
  netdata-lib:
  netdata-cache:
